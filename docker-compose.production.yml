version: '3.9'

# Production Docker Swarm Compose for GiftECommerce Microservices
# Deploy: docker stack deploy -c docker-compose.production.yml gift-shop-team1
#
# Image tags use static names (update manually when deploying new versions)
#
# Required Environment Variables (no defaults):
# JWT_SECRET_KEY=your_jwt_secret
# SMTP_HOST=smtp.gmail.com
# SMTP_USERNAME=your_email
# SMTP_PASSWORD=your_smtp_password
# STRIPE_SECRET_KEY=your_stripe_key
# STRIPE_PUBLISHABLE_KEY=your_stripe_key
#
# Optional Environment Variables (have defaults in compose file):
# GATEWAY_PORT=5000 IDENTITY_PORT=5001 CATEGORY_PORT=5002 INVENTORY_PORT=5003
# CART_PORT=5005 ORDER_PORT=5006 OFFER_PORT=5007 NOTIFICATION_PORT=5008 PROFILE_PORT=5009
# SQL_PASSWORD (default: g19HBzycmCfePY6MREFm)
# REDIS_PASSWORD (default: g19HBzycmCfePY6MREFm)
# RABBITMQ_PASSWORD (default: g19HBzycmCfePY6MREFm)
#
# Multi-team deployment: Use different stack names and port ranges (Team 1: 5000-5009, Team 2: 6000-6009, etc.)
# Services are automatically prefixed with stack name. Internal communication uses simple service names.

networks:
  default_overlay_network:
    external: true

volumes:
  uploads:
    driver: local

services:
  # ============================================
  # API GATEWAY (Main Entry Point)
  # ============================================
  gateway:
    user: root
    image: giftshop90/giftshop:api_t1-gateway-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${GATEWAY_PORT:-5000}:8080"
    volumes:
      - uploads:/app/Uploads
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
    depends_on:
      - identityservice
      - categoryservice
      - cartservice

  # ============================================
  # IDENTITY SERVICE
  # ============================================
  identityservice:
    user: root
    image: giftshop90/giftshop:api_t1-identity-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${IDENTITY_PORT:-5001}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=IdentityDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True}
      - Jwt__SecretKey=hhakjhsdkjaskjdhkas
      - Jwt__Issuer=${JWT_ISSUER:-gift-shop}
      - Jwt__Audience=${JWT_AUDIENCE:-gift-shop}
      - Email__Smtp__Host=${SMTP_HOST}
      - Email__Smtp__Port=${SMTP_PORT:-587}
      - Email__Smtp__Username=${SMTP_USERNAME}
      - Email__Smtp__Password=${SMTP_PASSWORD}
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm

  # ============================================
  # CATEGORY SERVICE
  # ============================================
  categoryservice:
    user: root
    image: giftshop90/giftshop:api_t1-category-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${CATEGORY_PORT:-5002}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=Ecommerce-CatalogDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True}
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm
      - ExternalServices__CartService__BaseUrl=http://cartservice:8080
      - ExternalServices__OrderService__BaseUrl=http://orderservice:8080
      - ExternalServices__InventoryService__BaseUrl=http://inventoryservice:8080

  # ============================================
  # INVENTORY SERVICE
  # ============================================
  inventoryservice:
    user: root
    image: giftshop90/giftshop:api_t1-inventory-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${INVENTORY_PORT:-5003}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=Ecommerce-InventoryDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True}
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm
      - ExternalServices__CartService__BaseUrl=http://cartservice:8080

  # ============================================
  # CART SERVICE
  # ============================================
  cartservice:
    user: root
    image: giftshop90/giftshop:api_t1-cart-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${CART_PORT:-5005}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__CartDatabase=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=CartServiceDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True}
      - Redis__ConnectionString=${REDIS_HOST:-72.61.102.216}:${REDIS_PORT:-6379},password=${REDIS_PASSWORD:-g19HBzycmCfePY6MREFm},abortConnect=false
      - Redis__InstanceName=CartService
      - ExternalServices__InventoryServiceBaseUrl=http://inventoryservice:8080
      - ExternalServices__ProfileServiceBaseUrl=http://userprofileservice:8080
      - ExternalServices__TimeoutInSeconds=30
      - ExternalServices__RetryCount=3
      - Jwt__Authority=http://identityservice:8080
      - Jwt__Audience=cart-service
      - Jwt__RequireHttpsMetadata=false
    depends_on:
      - identityservice
      - inventoryservice

  # ============================================
  # ORDER SERVICE
  # ============================================
  orderservice:
    user: root
    image: giftshop90/giftshop:api_t1-order-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${ORDER_PORT:-5006}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__OrderDatabase=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=OrderDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True}
      - Redis__ConnectionString=${REDIS_HOST:-72.61.102.216}:${REDIS_PORT:-6379},password=${REDIS_PASSWORD:-g19HBzycmCfePY6MREFm},abortConnect=false
      - Redis__InstanceName=OrderService
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm
      - ExternalServices__CartServiceBaseUrl=http://cartservice:8080
      - ExternalServices__InventoryServiceBaseUrl=http://inventoryservice:8080
      - ExternalServices__ProfileServiceBaseUrl=http://userprofileservice:8080
      - ExternalServices__TimeoutInSeconds=30
      - Stripe__SecretKey=${STRIPE_SECRET_KEY}
      - Stripe__PublishableKey=${STRIPE_PUBLISHABLE_KEY}
      - Jwt__Authority=http://identityservice:8080
      - Jwt__Audience=order-service
      - Jwt__RequireHttpsMetadata=false
    depends_on:
      - cartservice
      - inventoryservice
      - userprofileservice

  # ============================================
  # USER PROFILE SERVICE
  # ============================================
  userprofileservice:
    user: root
    image: giftshop90/giftshop:api_t1-profile-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${PROFILE_PORT:-5009}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=Server=72.61.102.216;Database=UserProfileDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm
      - Jwt__Key=g19HBzycmCfePY6MREFmJWTSecretKey2024Production
      - Jwt__Issuer=gift-shop
      - Jwt__Audience=gift-shop
    depends_on:
      - identityservice

  # ============================================
  # OFFER SERVICE
  # ============================================
  offerservice:
    user: root
    image: giftshop90/giftshop:api_t1-offer-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${OFFER_PORT:-5007}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=Server=72.61.102.216;Database=Ecommerce-OfferDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm

  # ============================================
  # NOTIFICATION SERVICE
  # ============================================
  notificationservice:
    user: root
    image: giftshop90/giftshop:api_t1-notification-202601170339
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${NOTIFICATION_PORT:-5008}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - RabbitMQ__Host=72.61.102.216
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=g19HBzycmCfePY6MREFm
