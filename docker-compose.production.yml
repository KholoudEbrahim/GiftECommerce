version: '3.9'

# Production Docker Swarm Compose for GiftECommerce Microservices
# Deploy with: docker stack deploy -c docker-compose.production.yml ${STACK_NAME:-gift-shop}
#
# IMPORTANT: To avoid conflicts with other projects on the same server, set unique prefixes:
# export STACK_NAME=gift-shop-team1
# export SERVICE_PREFIX=gift-shop
# export VOLUME_PREFIX=gift-shop
#
# Server IP: 72.61.102.216
#
# Database Connection:
#   Server: 72.61.102.216
#   User: sa
#   Password: g19HBzycmCfePY6MREFm (default, can be overridden via SQL_PASSWORD env var)
#
# RabbitMQ Connection:
#   Host: 72.61.102.216
#   AMQP Port: 5672
#   Management UI: http://72.61.102.216:15672
#   Username: admin
#   Password: g19HBzycmCfePY6MREFm (default, can be overridden via RABBITMQ_PASSWORD env var)
#
# Redis Connection:
#   Host: 72.61.102.216
#   Port: 6379
#   Management UI: http://72.61.102.216:8081
#   Password: g19HBzycmCfePY6MREFm (default, can be overridden via REDIS_PASSWORD env var)
#
# Port Mapping (to avoid conflicts with other microservices projects on the same server):
# - Gateway:       5000 (or GATEWAY_PORT env var)
# - Identity:      5001 (or IDENTITY_PORT env var)
# - Category:      5002 (or CATEGORY_PORT env var)
# - Inventory:     5003 (or INVENTORY_PORT env var)
# - Cart:          5005 (or CART_PORT env var)
# - Order:         5006 (or ORDER_PORT env var)
# - Offer:         5007 (or OFFER_PORT env var)
# - Notification: 5008 (or NOTIFICATION_PORT env var)
# - Profile:       5009 (or PROFILE_PORT env var)
#
# To change ports, set environment variables before deployment:
# export GATEWAY_PORT=6000
# export IDENTITY_PORT=6001
# etc.
#
# Resource Allocation (Optimized for 8GB RAM server with other services):
# - Gateway: 1G limit, 512M reservation (main entry point)
# - Other services: 512M limit, 256M reservation each
# - Total memory limits: ~5G (leaves ~3G for OS and other services)
# - CPU limits: Gateway 1.0, others 0.5 each

networks:
  default_overlay_network:
    external: true

volumes:
  ${VOLUME_PREFIX:-gift-shop}-uploads:
    driver: local

services:
  # ============================================
  # API GATEWAY (Main Entry Point)
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-gateway:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-gateway-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${GATEWAY_PORT:-5000}:8080"
    volumes:
      - ${VOLUME_PREFIX:-gift-shop}-uploads:/app/Uploads
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
    depends_on:
      - ${SERVICE_PREFIX:-gift-shop}-identityservice
      - ${SERVICE_PREFIX:-gift-shop}-categoryservice
      - ${SERVICE_PREFIX:-gift-shop}-cartservice

  # ============================================
  # IDENTITY SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-identityservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-identity-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${IDENTITY_PORT:-5001}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=IdentityDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}
      - Jwt__SecretKey=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER:-gift-shop}
      - Jwt__Audience=${JWT_AUDIENCE:-gift-shop}
      - Email__Smtp__Host=${SMTP_HOST}
      - Email__Smtp__Port=${SMTP_PORT:-587}
      - Email__Smtp__Username=${SMTP_USERNAME}
      - Email__Smtp__Password=${SMTP_PASSWORD}
      - RabbitMQ__Host=${RABBITMQ_HOST:-72.61.102.216}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Username=${RABBITMQ_USER:-admin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-g19HBzycmCfePY6MREFm}

  # ============================================
  # CATEGORY SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-categoryservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-category-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${CATEGORY_PORT:-5002}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=Ecommerce-CatalogDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}
      - RabbitMQ__Host=${RABBITMQ_HOST:-72.61.102.216}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Username=${RABBITMQ_USER:-admin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-g19HBzycmCfePY6MREFm}
      - ExternalServices__CartService__BaseUrl=http://${SERVICE_PREFIX:-gift-shop}-cartservice:8080
      - ExternalServices__OrderService__BaseUrl=http://${SERVICE_PREFIX:-gift-shop}-orderservice:8080
      - ExternalServices__InventoryService__BaseUrl=http://${SERVICE_PREFIX:-gift-shop}-inventoryservice:8080

  # ============================================
  # INVENTORY SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-inventoryservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-inventory-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${INVENTORY_PORT:-5003}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=Ecommerce-InventoryDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}
      - RabbitMQ__Host=${RABBITMQ_HOST:-72.61.102.216}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Username=${RABBITMQ_USER:-admin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-g19HBzycmCfePY6MREFm}
      - ExternalServices__CartService__BaseUrl=http://${SERVICE_PREFIX:-gift-shop}-cartservice:8080

  # ============================================
  # CART SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-cartservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-cart-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${CART_PORT:-5005}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__CartDatabase=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=CartServiceDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}
      - Redis__ConnectionString=${REDIS_HOST:-72.61.102.216}:${REDIS_PORT:-6379},password=${REDIS_PASSWORD:-g19HBzycmCfePY6MREFm},abortConnect=false
      - Redis__InstanceName=CartService
      - ExternalServices__InventoryServiceBaseUrl=http://${SERVICE_PREFIX:-gift-shop}-inventoryservice:8080
      - ExternalServices__ProfileServiceBaseUrl=http://${SERVICE_PREFIX:-gift-shop}-userprofileservice:8080
      - ExternalServices__TimeoutInSeconds=30
      - ExternalServices__RetryCount=3
      - Jwt__Authority=http://${SERVICE_PREFIX:-gift-shop}-identityservice:8080
      - Jwt__Audience=cart-service
      - Jwt__RequireHttpsMetadata=false
    depends_on:
      - ${SERVICE_PREFIX:-gift-shop}-identityservice
      - ${SERVICE_PREFIX:-gift-shop}-inventoryservice

  # ============================================
  # ORDER SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-orderservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-order-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${ORDER_PORT:-5006}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__OrderDatabase=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=OrderDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}
      - Redis__ConnectionString=${REDIS_HOST:-72.61.102.216}:${REDIS_PORT:-6379},password=${REDIS_PASSWORD:-g19HBzycmCfePY6MREFm},abortConnect=false
      - Redis__InstanceName=OrderService
      - RabbitMQ__Host=${RABBITMQ_HOST:-72.61.102.216}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Username=${RABBITMQ_USER:-admin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-g19HBzycmCfePY6MREFm}
      - ExternalServices__CartServiceBaseUrl=http://${SERVICE_PREFIX:-gift-shop}-cartservice:8080
      - ExternalServices__InventoryServiceBaseUrl=http://${SERVICE_PREFIX:-gift-shop}-inventoryservice:8080
      - ExternalServices__ProfileServiceBaseUrl=http://${SERVICE_PREFIX:-gift-shop}-userprofileservice:8080
      - ExternalServices__TimeoutInSeconds=30
      - Stripe__SecretKey=${STRIPE_SECRET_KEY}
      - Stripe__PublishableKey=${STRIPE_PUBLISHABLE_KEY}
      - Jwt__Authority=http://${SERVICE_PREFIX:-gift-shop}-identityservice:8080
      - Jwt__Audience=order-service
      - Jwt__RequireHttpsMetadata=false
    depends_on:
      - ${SERVICE_PREFIX:-gift-shop}-cartservice
      - ${SERVICE_PREFIX:-gift-shop}-inventoryservice
      - ${SERVICE_PREFIX:-gift-shop}-userprofileservice

  # ============================================
  # USER PROFILE SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-userprofileservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-profile-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${PROFILE_PORT:-5009}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=UserProfileDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}
      - RabbitMQ__Host=${RABBITMQ_HOST:-72.61.102.216}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Username=${RABBITMQ_USER:-admin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-g19HBzycmCfePY6MREFm}
    depends_on:
      - ${SERVICE_PREFIX:-gift-shop}-identityservice

  # ============================================
  # OFFER SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-offerservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-offer-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${OFFER_PORT:-5007}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=${SQL_CONNECTION_STRING:-Server=72.61.102.216;Database=Ecommerce-OfferDb;User Id=${SQL_USER:-sa};Password=${SQL_PASSWORD:-g19HBzycmCfePY6MREFm};TrustServerCertificate=True}

  # ============================================
  # NOTIFICATION SERVICE
  # ============================================
  ${SERVICE_PREFIX:-gift-shop}-notificationservice:
    user: root
    image: giftshop90/giftshop:${BACKEND_ENV:-api_t1}-notification-${TAG}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
      restart_policy:
        condition: any
        delay: 60s
        max_attempts: 6
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.2
    stop_grace_period: 30s
    networks:
      - default_overlay_network
    ports:
      - "${NOTIFICATION_PORT:-5008}:8080"
    environment:
      - ENVIRONMENT_TYPE=3
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - TZ=Africa/Cairo
      - DOTNET_RUNNING_IN_CONTAINER=true
      - RabbitMQ__Host=${RABBITMQ_HOST:-72.61.102.216}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Username=${RABBITMQ_USER:-admin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-g19HBzycmCfePY6MREFm}
