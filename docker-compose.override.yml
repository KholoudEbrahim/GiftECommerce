
services:
  # Infrastructure Services
 

  redis:
    image: redis:7-alpine
    container_name: gift-ecommerce-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass RedisPass123!
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    

  rabbit:
    image: rabbitmq:3.13-management
    container_name: gift-ecommerce-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "check_port_listener", "5672"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Application Services Configuration
  identityservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=Server=72.61.102.216;Database=IdentityDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
    command: ["dotnet", "IdentityService.dll", "--urls", "http://0.0.0.0:8080"]



  userprofileservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=Server=72.61.102.216;Database=UserProfileDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
    command: ["dotnet", "UserProfileService.dll", "--urls", "http://0.0.0.0:8080"]

 

  inventoryservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=Server=72.61.102.216;Database=Ecommerce-InventoryDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
    command: ["dotnet", "InventoryService.dll", "--urls", "http://0.0.0.0:8080"]

  
  categoryservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__DefaultConnection=Server=72.61.102.216;Database=Ecommerce-CatalogDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
    command: ["dotnet", "CategoryService.dll", "--urls", "http://0.0.0.0:8080"]
    depends_on:
    - redis

  cartservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_RUNNING_IN_CONTAINER=true
      - ConnectionStrings__CartDatabase=Server=72.61.102.216;Database=CartServiceDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
      - Redis__ConnectionString=redis:6379,abortConnect=false
      - Redis__InstanceName=CartService
      - ExternalServices__InventoryServiceBaseUrl=http://categoryservice:8080
      - ExternalServices__ProfileServiceBaseUrl=http://userprofileservice:8080
      - ExternalServices__TimeoutInSeconds=30
      - ExternalServices__RetryCount=3
      - Jwt__Authority=http://identityservice:8080
      - Jwt__Audience=cart-service
      - Jwt__RequireHttpsMetadata=false
    ports:
      - "5005:8080"
    depends_on:
     
      - redis
      - identityservice


  orderservice:
   image: ${DOCKER_REGISTRY-}orderservice
   build:
    context: .
    dockerfile: OrderService/Dockerfile
   container_name: gift-ecommerce-order
   ports:
    - "5006:8080" 
   environment:
    - ASPNETCORE_ENVIRONMENT=Development
    - ASPNETCORE_HTTP_PORTS=8080
    - ASPNETCORE_HTTPS_PORTS=8081
    - DOTNET_RUNNING_IN_CONTAINER=true
    - ConnectionStrings__OrderDatabase=Server=72.61.102.216;Database=OrderDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
    - Redis__ConnectionString=redis:6379,abortConnect=false
    - Redis__InstanceName=OrderService
    - RabbitMQ__Host=rabbit
    - RabbitMQ__Username=admin
    - RabbitMQ__Password=admin123
    - ExternalServices__CartServiceBaseUrl=http://cartservice:8080
    - ExternalServices__InventoryServiceBaseUrl=http://inventoryservice:8080
    - ExternalServices__ProfileServiceBaseUrl=http://userprofileservice:8080
    - ExternalServices__TimeoutInSeconds=30
    - Jwt__Authority=http://identityservice:8080
    - Jwt__Audience=order-service
    - Jwt__RequireHttpsMetadata=false
   depends_on:
      
      - redis
      - cartservice
      - inventoryservice
      - userprofileservice

  offerservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081


  notificationservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__OrderDatabase=Server=72.61.102.216;Database=Ecommerce-OfferDb;User Id=sa;Password=g19HBzycmCfePY6MREFm;TrustServerCertificate=True;MultipleActiveResultSets=true
      - ASPNETCORE_HTTPS_PORTS=8081
    depends_on:
      - rabbit
       
  gateway:
    depends_on:
      - identityservice
      - categoryservice


 
