name: Production Build & Deploy

on:
  push:
    branches: [ 'master' ]

concurrency:
  group: docker-build-production
  cancel-in-progress: true

env:
  DOCKER_REGISTRY: giftshop90
  DOCKER_REPO: giftshop
  BACKEND_ENV: api_t1

jobs:
  generate-tag:
    name: Generate Timestamp
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.timestamp.outputs.tag }}
    steps:
      - name: Generate timestamp for tagging (Egypt Time Zone)
        id: timestamp
        run: |
          export TZ=Africa/Cairo
          echo "tag=$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build & Push ${{ matrix.service }}
    needs: generate-tag
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: gateway
            dockerfile: ./ApiGateway/Dockerfile
          - service: identity
            dockerfile: ./IdentityService/Dockerfile
          - service: category
            dockerfile: ./CategoryService/Dockerfile
          - service: inventory
            dockerfile: ./InventoryService/Dockerfile
          - service: cart
            dockerfile: ./CartService/Dockerfile
          - service: order
            dockerfile: ./OrderService/Dockerfile
          - service: profile
            dockerfile: ./UserProfileService/Dockerfile
          - service: offer
            dockerfile: ./OfferService/Dockerfile
          - service: notification
            dockerfile: ./NotificationService/Dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          install: true
          driver-opts: network=host

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-${{ matrix.service }}-${{ needs.generate-tag.outputs.tag }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  summary:
    name: Deployment Summary
    needs: [generate-tag, build-and-push]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Output deployment tag
        run: |
          echo "## ðŸš€ Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tag Format" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.BACKEND_ENV }}-{service}-${{ needs.generate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "export BACKEND_ENV=${{ env.BACKEND_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "export TAG=${{ needs.generate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "docker stack deploy -c docker-compose.production.yml gift-shop-team1" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### All Images Pushed" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-gateway-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-identity-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-category-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-inventory-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-cart-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-order-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-profile-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-offer-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}:${{ env.BACKEND_ENV }}-notification-${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** \`${{ needs.generate-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ env.BACKEND_ENV }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "All services built and pushed in parallel for faster execution." >> $GITHUB_STEP_SUMMARY
